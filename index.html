<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AUTOMATED MEDICINE DISPENSER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    h2 { color: #0b63b3; margin-bottom: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
    th { background: #f7f7f7; font-weight: 600; }

    /* ✅ Event colors */
    .taken { color: #108a00; font-weight: 700; }
    .not-taken { color: #c20b00; font-weight: 700; }
    .triggered { color: #b36b00; font-weight: 700; }
    .sos { color: #9b1b1b; font-weight: 700; }
    .ok { color: #108a00; font-weight: 700; } /* ✅ Bright green for I AM OK */

    .row-latest { background: #fff8d6; }
    #status { margin-top: 10px; color: #666; font-size: 13px; }
    #debug { margin-top: 6px; color: #333; font-size: 13px; }
    #clearBtn {
      margin-top: 12px;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #d9534f;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }
    #clearBtn:hover { background: #c9302c; }
    @media (max-width:600px){ th, td{ font-size:13px; padding:6px; } }
  </style>
</head>
<body>
  <h2>AUTOMATED MEDICINE DISPENSER</h2>
  <div id="status">Connecting to Firebase...</div>
  <div id="debug" aria-hidden="true"></div>

  <button id="clearBtn" onclick="clearAllData()">✨ Clear All Data</button>

  <table aria-labelledby="AUTOMATED MEDICINE DISPENSER">
    <thead>
      <tr>
        <th style="width:40%;">Time</th>
        <th style="width:60%;">Event</th>
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, onChildAdded, onChildChanged, onValue, remove } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiABZJHcg074VU2Q1hP8KJTjd2Ep59t8k",
      authDomain: "automated-medicine-dispe-2e57a.firebaseapp.com",
      databaseURL: "https://automated-medicine-dispe-2e57a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "automated-medicine-dispe-2e57a",
      storageBucket: "automated-medicine-dispe-2e57a.appspot.com",
      messagingSenderId: "32551192089",
      appId: "1:32551192089:web:622896cde5b35bca4f8c88"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const eventsRef = ref(db, "devices/dispense01/events");

    const statusDiv = document.getElementById("status");
    const debugDiv = document.getElementById("debug");
    const logTable = document.getElementById("log");

    window.clearAllData = function() {
      if (confirm("⚠️ Are you sure you want to delete ALL event logs?")) {
        remove(eventsRef)
          .then(() => {
            logTable.innerHTML = "";
            statusDiv.textContent = "All events cleared.";
          })
          .catch((err) => alert("❌ Failed: " + err.message));
      }
    };

    const rows = new Map();

    function formatTimestamp(tsSeconds) {
      if (!tsSeconds) return "No time";
      let seconds = tsSeconds > 1e12 ? tsSeconds / 1000 : tsSeconds;
      return new Date(seconds * 1000).toLocaleString("en-IN", { hour12: true });
    }

    function cleanEventName(ev) {
      // ✅ Converts "I_AM_OK" → "I AM OK"
      return ev.replace(/_/g, " ");
    }

    function createRowElement(key, value, isLatest = false) {
      const tr = document.createElement("tr");
      tr.id = `row-${key}`;

      const timeTd = document.createElement("td");
      const eventTd = document.createElement("td");

      timeTd.textContent = formatTimestamp(value.timestamp || null);

      const ev = value.event || "UNKNOWN";
      eventTd.textContent = cleanEventName(ev);

      // ✅ Apply color styles
      if (ev === "TAKEN") eventTd.classList.add("taken");
      else if (ev === "NOT_TAKEN") eventTd.classList.add("not-taken");
      else if (ev === "DOSE_TRIGGERED") eventTd.classList.add("triggered");
      else if (ev === "SOS") eventTd.classList.add("sos");
      else if (ev === "I_AM_OK") eventTd.classList.add("ok");

      tr.appendChild(timeTd);
      tr.appendChild(eventTd);
      if (isLatest) tr.classList.add("row-latest");
      return tr;
    }

    function addChild(key, value) {
      if (rows.has(key)) return;
      const newRow = createRowElement(key, value, true);
      const prevLatest = document.querySelector(".row-latest");
      if (prevLatest) prevLatest.classList.remove("row-latest");
      logTable.appendChild(newRow);
      rows.set(key, newRow);
      statusDiv.textContent = `Connected — last event: ${cleanEventName(value.event)}`;
    }

    get(eventsRef).then(snapshot => {
      if (!snapshot.exists()) {
        statusDiv.textContent = "Connected — no events yet.";
        return;
      }
      snapshot.forEach(child => addChild(child.key, child.val()));
      statusDiv.textContent = "Listening for updates...";
    });

    onChildAdded(eventsRef, snap => addChild(snap.key, snap.val()));
    onChildChanged(eventsRef, snap => addChild(snap.key, snap.val()));
  </script>
</body>
</html>




